<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Water tube</title>
    <style>
      html,
      body {
        margin: 0;
        height: 100%;
        background-color: #000;
        color: #eee;
      }
      main {
        border: 1px solid;
        padding-top: 200px;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
      }

      .tube-container {
        position: relative;
        /* border: 1px solid red; */
        padding: 16px;
        width: 50px;
        height: 150px;
        flex-shrink: 0;
      }
      .water-tube {
        /* width: 100%;
        height: 100%; */
        width: 50px;
        height: 150px;
        border: 1px solid;
        display: flex;
        /* flex-direction: column;
        transform: rotate(180deg); */
        flex-direction: column-reverse;
      }
      .water-tube.selected {
        box-shadow: 0px 0px 24px #999;
      }

      .hook-point {
        width: 6px;
        height: 6px;
        background-color: #999;
        position: absolute;
        left: 50%;
        transform: translate(-50%, -40px);
        /* top: -42px; */
      }

      .water {
        width: 100%;
        height: 25%;
        border: 1px dashed #999;
      }
    </style>
  </head>
  <body>
    <main></main>

    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.7/dist/gsap.min.js"></script>
    <script>
      class View {
        canvas;

        constructor() {
          this.canvas = document.querySelector("main");
        }

        drawTube(waters, idx) {
          const tubeContainer = document.createElement("div");
          tubeContainer.classList.add(`tube-container`);
          tubeContainer.classList.add(`tube-container-${idx}`);
          tubeContainer.dataset.idx = idx;

          const tube = document.createElement("div");
          tube.classList.add(`water-tube`);
          tube.classList.add(`water-tube-${idx}`);
          tube.dataset.idx = idx;

          const hookPoint = document.createElement("div");
          hookPoint.classList.add("hook-point");

          tubeContainer.append(hookPoint);
          tubeContainer.append(tube);

          waters.forEach((color, i) => {
            if (color) this.drawWater(tube, color, i);
            // this.#drawWater(tube, color || "transparent", i);
          });

          this.canvas.append(tubeContainer);
        }

        drawWater(tube, color, idx) {
          const water = document.createElement("div");
          water.classList.add("water");
          water.classList.add(`water-${idx}`);
          water.classList.add(color);
          water.style.backgroundColor = color;
          water.dataset.idx = idx;
          water.dataset.color = color;

          tube.append(water);
        }

        getAllTubeElements() {
          return [...document.querySelectorAll(`.water-tube`)];
        }

        /**
         * @param tubeIdx {number}
         * @returns {HTMLDivElement}
         **/
        getTubeElement(tubeIdx) {
          return document.querySelector(`.water-tube-${tubeIdx}`);
        }

        getTubeHookPoint(tubeIdx) {
          return document.querySelector(`.water-tube-${tubeIdx} .hook-point`);
        }

        /**
         * @param tubeIdx {number}
         * @param waterIdx {number}
         * @returns {HTMLDivElement | null}
         * */
        getWaterElement(tubeIdx, waterIdx) {
          return document.querySelector(`.water-tube-${tubeIdx} .water-${waterIdx}`);
        }

        getTopWater(tubeIdx) {
          let i = 3;
          while (i >= 0) {
            const waterEl = this.getWaterElement(tubeIdx, i);
            if (waterEl) {
              return { idx: i, element: waterEl, color: waterEl.dataset.color };
            }
            i--;
          }
          return { idx: -1, element: null, color: null };
        }

        performWaterSpill(sourceTubeIdx, targetTubeIdx) {
          const selectedTube = this.getTubeElement(sourceTubeIdx);
          const targetTube = this.getTubeElement(targetTubeIdx);

          const targetHookPoint = targetTube.parentElement.children.item(0);

          const startPoint = selectedTube.getBoundingClientRect();
          const hookPoint = targetHookPoint.getBoundingClientRect();

          selectedTube.classList.add("locked");
          // move tube to target
          gsap.fromTo(
            `.water-tube-${sourceTubeIdx}`,
            { position: "fixed", zIndex: 100 },
            { top: `${hookPoint.y}`, left: `${hookPoint.x}px` }
          );
          setTimeout(() => {
            // spill start
            gsap.to(`.water-tube-${sourceTubeIdx}`, {
              transformOrigin: "top center",
              transform: "rotate(-90deg)",
            });

            const selectedTubeWater = this.getTopWater(sourceTubeIdx);
            const targetTopWater = this.getTopWater(targetTubeIdx);

            this.drawWater(targetTube, selectedTubeWater.color, targetTopWater.idx + 1);
            const newTopWater = this.getTopWater(targetTubeIdx);

            // animate new water filling
            gsap.fromTo(`.water-tube-${targetTubeIdx} .water-${newTopWater.idx}`, { height: "0%" }, { height: "25%" });
            // animate old water draining
            gsap.to(`.water-tube-${sourceTubeIdx} .water-${selectedTubeWater.idx}`, { height: "0%" });

            // spill end
            setTimeout(() => {
              selectedTubeWater.element.remove();

              gsap.to(`.water-tube-${sourceTubeIdx}`, {
                transform: "rotate(0deg)",
              });

              setTimeout(() => {
                // back to initial tube position
                gsap.to(`.water-tube-${sourceTubeIdx}`, {
                  top: `${startPoint.y + 20}`,
                  left: `${startPoint.x}px`,
                });

                setTimeout(() => {
                  // end
                  gsap.to(`.water-tube-${sourceTubeIdx}`, {
                    position: "unset",
                    zIndex: 1,
                  });

                  selectedTube.classList.remove("locked");
                }, 400);
              }, 400);
            }, 400);
          }, 400);
        }

        /** @param selectedTubeIdx {number | null}  */
        updateSelectedTube(selectedTubeIdx) {
          this.getAllTubeElements().forEach((ele) => {
            if (ele.classList.contains("selected")) {
              gsap.to(".selected", {
                transform: "translateY(0px)",
                duration: 0.2,
              });
            }

            if (selectedTubeIdx == null || +ele.dataset.idx != selectedTubeIdx) {
              ele.classList.remove("selected");
            }
            if (+ele.dataset.idx == selectedTubeIdx) {
              ele.classList.add("selected");
            }

            if (ele.classList.contains("selected")) {
              gsap.to(".selected", {
                transform: "translateY(-20px)",
                duration: 0.2,
              });
            }
          });
        }
      }

      class Controller {
        game;
        view;
        selectedTubeIdx = null;

        constructor(game) {
          this.game = game;
          this.view = new View();

          this.game.forEach((tubeColors, idx) => {
            this.view.drawTube(tubeColors, idx);
            const tubeEl = this.view.getTubeElement(idx);
            tubeEl.addEventListener("click", this.#onTubeClick.bind(this));
          });
        }

        canSpillWater(sourceTubeIdx, targetTubeIdx) {
          const selectedTube = this.view.getTubeElement(sourceTubeIdx);
          const targetTube = this.view.getTubeElement(targetTubeIdx);
          const selectedTubeWater = this.view.getTopWater(sourceTubeIdx);
          const targetTopWater = this.view.getTopWater(targetTubeIdx);

          const tubeAHasWater = selectedTubeWater.idx >= 0;
          const tubeBHasSpace = targetTopWater.idx < 3;
          const tubeBIsEmpty = targetTopWater.idx < 0;
          const areColorsEqual = targetTopWater.color == selectedTubeWater.color;

          const canSpillWater = tubeAHasWater && tubeBHasSpace && (areColorsEqual || tubeBIsEmpty);

          return canSpillWater;
        }

        #onTubeClick(ev) {
          const targetTube = ev.target.closest(".water-tube");
          const targetTubeIdx = Number(targetTube.dataset.idx);

          if (targetTube.classList.contains("locked")) {
            return;
          }

          if (this.selectedTubeIdx == null) {
            this.selectedTubeIdx = targetTubeIdx;
          } else {
            if (this.selectedTubeIdx == targetTubeIdx) {
              this.selectedTubeIdx = null;
            } else {
              if (this.canSpillWater(this.selectedTubeIdx, targetTubeIdx)) {
                console.log("SPILL THAT WATER!!!");

                this.view.performWaterSpill(this.selectedTubeIdx, targetTubeIdx);
                this.selectedTubeIdx = null;
              } else {
                this.selectedTubeIdx = targetTubeIdx;
              }
            }
          }

          //   if (this.selectedTubeIdx === null) this.selectedTubeIdx = targetTubeIdx;
          //   //
          //   else if (this.selectedTubeIdx === targetTubeIdx) this.selectedTubeIdx = null;
          //   //
          //   else if (this.canSpillWater(this.selectedTubeIdx, targetTubeIdx)) {
          //     console.log("SPILL THAT WATER!!!");
          //     // await performSpill()
          //     // console.log({ ev, tubeEl, tubeIdx, v: this.view, targetTopWater });
          //     this.selectedTubeIdx = null;
          //   }
          //   //
          //   else {
          //     this.selectedTubeIdx = targetTubeIdx;
          //   }

          this.view.updateSelectedTube(this.selectedTubeIdx);
        }
      }

      const controller = new Controller([
        ["red", "red", "red", null],
        ["green", "blue", "green", "green"],
        ["blue", "blue", "blue", "green"],
        [null, null, null, null],
        ["orange", "orange", null, null],
        ["orange", "orange", null, null],
        ["purple", "purple", "purple", null],
        ["purple", "red", null, null],
      ]);

      //   console.log(view.getTubeElement(0));
      //   console.log(view.getWaterElement(0, 2));
    </script>
  </body>
</html>
